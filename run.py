import pytest
import os
import sys
from pathlib import Path  # æ›´ä¼˜é›…çš„è·¯å¾„å¤„ç†ï¼ˆå…¼å®¹Windows/Mac/Linuxï¼‰

def run_tests():
    """
    è‡ªåŠ¨åŒ–æµ‹è¯•æ‰§è¡Œå…¥å£å‡½æ•°
    åŠŸèƒ½ï¼š
    1. è‡ªåŠ¨åˆ›å»ºæŠ¥å‘Šç›®å½•ï¼ˆé¿å…ç›®å½•ä¸å­˜åœ¨æŠ¥é”™ï¼‰
    2. æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹å¹¶æ•è·æ‰§è¡Œç»“æœ
    3. è¾“å‡ºæ¸…æ™°çš„æ‰§è¡ŒçŠ¶æ€ï¼ˆæˆåŠŸ/å¤±è´¥ï¼‰
    4. å…¼å®¹å¤šç³»ç»Ÿè·¯å¾„æ ¼å¼
    """
    # ========== 1. é…ç½®åŸºç¡€å‚æ•°ï¼ˆå¯æ ¹æ®éœ€æ±‚è°ƒæ•´ï¼‰ ==========
    test_dir = "testcases"  # æµ‹è¯•ç”¨ä¾‹ç›®å½•
    report_dir = "./report/allure_report"  # allureåŸå§‹æŠ¥å‘Šç›®å½•
    # è½¬æ¢ä¸ºPathå¯¹è±¡ï¼Œå…¼å®¹ä¸åŒç³»ç»Ÿè·¯å¾„åˆ†éš”ç¬¦ï¼ˆ\ /ï¼‰
    report_path = Path(report_dir)

    # ========== 2. ç¡®ä¿æŠ¥å‘Šç›®å½•å­˜åœ¨ ==========
    if not report_path.exists():
        report_path.mkdir(parents=True, exist_ok=True)  # parents=Trueï¼šè‡ªåŠ¨åˆ›å»ºå¤šçº§ç›®å½•
        print(f"ğŸ“ è‡ªåŠ¨åˆ›å»ºæŠ¥å‘Šç›®å½•ï¼š{report_path.absolute()}")

    # ========== 3. æ„é€ pytestæ‰§è¡Œå‚æ•° ==========
    pytest_args = [
        test_dir,
        "-v",  # è¯¦ç»†è¾“å‡ºç”¨ä¾‹æ‰§è¡Œç»“æœ
        "-s",  # æ‰“å°ç”¨ä¾‹ä¸­çš„print/æ—¥å¿—
        f"--alluredir={report_path}",  # æŒ‡å®šallureæŠ¥å‘Šç›®å½•
        "--clean-alluredir",  # æ¸…ç©ºæ—§æŠ¥å‘Šæ•°æ®
        "--tb=short",  # ç®€åŒ–å¼‚å¸¸æ ˆä¿¡æ¯ï¼ˆé¿å…è¾“å‡ºè¿‡é•¿ï¼‰
        "-q"  # ç²¾ç®€è¾“å‡ºï¼ˆå¯é€‰ï¼Œå»æ‰-vçš„å†—ä½™ä¿¡æ¯ï¼‰
    ]

    # ========== 4. æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹å¹¶æ•è·ç»“æœ ==========
    print("\nğŸš€ å¼€å§‹è¿è¡Œè‡ªåŠ¨åŒ–æµ‹è¯•ç”¨ä¾‹...")
    try:
        # æ‰§è¡Œpytestå¹¶è·å–é€€å‡ºç ï¼ˆ0=å…¨éƒ¨é€šè¿‡ï¼Œé0=å­˜åœ¨å¤±è´¥/é”™è¯¯ï¼‰
        exit_code = pytest.main(pytest_args)

        # ========== 5. è¾“å‡ºæ‰§è¡Œç»“æœ ==========
        if exit_code == 0:
            print("\nâœ… æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹æ‰§è¡Œé€šè¿‡ï¼ğŸ‰")
        elif exit_code == 1:
            print("\nâŒ éƒ¨åˆ†æµ‹è¯•ç”¨ä¾‹æ‰§è¡Œå¤±è´¥ï¼âŒ")
        elif exit_code == 2:
            print("\nâš ï¸ æµ‹è¯•ç”¨ä¾‹è¢«ä¸­æ–­/å–æ¶ˆæ‰§è¡Œï¼")
        else:
            print(f"\nâ“ æµ‹è¯•æ‰§è¡Œå¼‚å¸¸ï¼Œé€€å‡ºç ï¼š{exit_code}")

    except Exception as e:
        print(f"\nğŸ’¥ æµ‹è¯•æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼š{str(e)}")
        sys.exit(1)  # å¼‚å¸¸é€€å‡ºï¼Œæ ‡è®°æ‰§è¡Œå¤±è´¥

    # ========== 6. è¾“å‡ºæŠ¥å‘ŠæŸ¥çœ‹æç¤º ==========
    print(f"\nğŸ’¡ æŸ¥çœ‹AllureæŠ¥å‘Šè¯·æ‰§è¡Œï¼š")
    print(f"   allure serve {report_path.absolute()}")
    # è¡¥å……ç”Ÿæˆé™æ€HTMLæŠ¥å‘Šçš„å‘½ä»¤ï¼ˆå¤‡ç”¨ï¼‰
    print(f"   ç”Ÿæˆé™æ€æŠ¥å‘Šï¼šallure generate {report_path} -o ./report/html --clean")

if __name__ == "__main__":
    run_tests()